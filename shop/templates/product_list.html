{% extends "base.html" %}

{% block title %}Каталог товаров | Apple Store{% endblock %}

{% block content %}
  <div class="container py-4">
    <div class="row g-4 align-items-start">

      <!-- Sidebar -->
      <div class="col-12 col-md-4 col-lg-3">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">
              <i class="bi bi-filter-circle me-2"></i>Категории
            </h5>

            <div class="list-group list-group-flush">
              <a
                href="{% url 'product_list' %}?q={{ query|urlencode }}&sort={{ sort }}"
                class="list-group-item list-group-item-action border-0 py-3"
              >
                <i class="bi bi-grid-3x3 me-2"></i>Все товары
                <span class="badge bg-secondary float-end">{{ products|length }}</span>
              </a>

              {% for cat in categories %}
                <a
                  href="{% url 'product_list_by_category' cat.slug %}?q={{ query|urlencode }}&sort={{ sort }}"
                  class="list-group-item list-group-item-action border-0 py-3"
                >
                  <i class="bi bi-tag me-2"></i>{{ cat.name }}
                </a>
              {% endfor %}
            </div>

          </div>
        </div>
      </div>

      <!-- Main content -->
      <div class="col-12 col-md-8 col-lg-9">
        <h1 class="h3 mb-4">
          {% if selected_category %}
            {{ selected_category.name }}
          {% else %}
            Все товары
          {% endif %}
        </h1>

        <!-- Search + sort -->
        <form method="get" class="row g-2 align-items-center mb-3">
          <div class="col-12 col-md-6">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-search"></i>
              </span>

              <input
                type="text"
                name="q"
                value="{{ query|default_if_none:'' }}"
                class="form-control"
                placeholder="Поиск по товарам..."
              >

              <button class="btn btn-outline-dark" type="submit">Найти</button>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <select name="sort" class="form-select" onchange="this.form.submit()">
              <option value="default" {% if sort == "default" %}selected{% endif %}>
                Сортировка: по умолчанию
              </option>
              <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>
                Цена: по возрастанию
              </option>
              <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>
                Цена: по убыванию
              </option>
            </select>
          </div>
        </form>

        <!-- Products -->
        <div class="row g-4">
          {% for product in products %}
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="card h-100 border-0 shadow-sm">

                <div style="height: 200px; background: #f5f5f7; overflow: hidden;">
                  {% if product.image_url %}
                    <img
                      src="{{ product.image_url }}"
                      alt="{{ product.name }}"
                      class="w-100 h-100 object-fit-cover"
                    >
                  {% else %}
                    <div class="h-100 d-flex align-items-center justify-content-center">
                      <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                    </div>
                  {% endif %}
                </div>

                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">{{ product.name }}</h5>
                  <p class="text-muted small mb-2">{{ product.category.name }}</p>
                  <p class="h5 mb-3">{{ product.price }} ₽</p>

                  <div class="mt-auto">
                    <form action="{% url 'cart_add' product.id %}" method="post" class="d-inline-block w-100 mb-2">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-cart-plus me-1"></i>В корзину
                      </button>
                    </form>

                    <a
                      href="{% url 'product_detail' product.slug %}"
                      class="btn btn-outline-dark w-100"
                    >
                      Подробнее
                    </a>
                  </div>
                </div>

              </div>
            </div>
          {% empty %}
            <div class="col-12">
              <p class="text-center text-muted py-5">Товаров пока нет</p>
            </div>
          {% endfor %}
        </div>

        <!-- PAGINATION -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">

            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&q={{ query|urlencode }}&sort={{ sort }}">
                  Назад
                </a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Назад</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ num }}&q={{ query|urlencode }}&sort={{ sort }}">
                    {{ num }}
                  </a>
                </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&q={{ query|urlencode }}&sort={{ sort }}">
                  Вперёд
                </a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Вперёд</span></li>
            {% endif %}

          </ul>
        </nav>
        {% endif %}

      </div>
    </div>
  </div>
{% endblock %}
